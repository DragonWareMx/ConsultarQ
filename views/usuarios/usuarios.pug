extends ../main

block head
    title ConsultarQ - Usuarios
    link(rel="stylesheet" href="/stylesheets/others.css")
block content
    div(class="uk-container")
        div(class="uk-flex uk-flex-between uk-margin-top uk-flex-middle uk-flex-wrap")
            div(class="uk-text-left   uk-text-large   uk-text-bold uk-text-primary uk-margin-bottom") Administrar Usuarios
            div(class="uk-animation-toggle uk-margin-bottom" tabindex="0")
                a(class="uk-text-right uk-flex-inline uk-flex uk-flex-middle uk-text-primary uk-link-heading uk-animation-shake" uk-toggle="target: #user-form")
                    img(src="/icons/more.png" style="width:20px;height:20px;margin-top:3px" class="uk-margin-small-right")
                    div Nuevo Usuario
        div(class="uk-child-width-1-2@s" uk-grid)
            each usuario in usuarios
                div
                    div(class="uk-card uk-card-default uk-width-1")
                        div(class="uk-card-body uk-flex uk-flex-top uk-padding-small")
                            div(class="uk-width-auto")
                                if usuario.picture
                                     img(src="/uploads/"+usuario.picture alt="" class="uk-border-circle uk-margin-auto uk-flex" style="width:94px;height:94px; background-size:cover; object-fit:cover;")
                                else
                                    img(src="/img/iconos/default.png" alt="" class="uk-border-circle uk-margin-auto uk-flex" style="width:94px;height:94px; background-size:cover; object-fit:cover;")
                            div(class="uk-width-expand uk-margin-small-left")
                                div(class="uk-margin-remove-top uk-flex uk-flex-between uk-flex-wrap-reverse" style="margin-bottom:5px")
                                    div #{usuario.Employee.name}
                                    div(class="uk-animation-toggle" tabindex="0")
                                    a(class="uk-text-right uk-flex-inline uk-flex uk-flex-middle uk-text-primary uk-link-heading uk-animation-shake uk-margin-remove-right uk-margin-auto-left" href="/usuarios/editar/"+usuario.id)
                                        img(src="/icons/edit.png" style="width:10px;height:10px" class="uk-margin-small-right")
                                        div(class="uk-text-small") Editar
                                div(class="uk-text-small uk-margin-remove-top" style="margin-bottom:5px;overflow-wrap: break-word;") #{usuario.email}
                                div(class="uk-text-small uk-margin-remove-top" style="margin-bottom:5px") #{usuario.Employee.phone_number}
                                div(class="uk-flex uk-margin-top uk-flex-middle uk-flex-wrap uk-margin-remove-top")
                                    div(class="uk-text-small uk-text-muted uk-margin-remove-top uk-margin-right" style="margin-bottom:5px") Estatus:
                                    span(class=(usuario.status === "active" ? "uk-label uk-label-success" : "uk-label uk-label-danger"))
                                        if usuario.status === "active"
                                            | Activo
                                        else
                                            | Inactivo
                        div(class="uk-card-footer uk-flex uk-flex-top uk-padding-small")
                            div(class="uk-width-auto uk-margin-small-top")
                                div(class="uk-text-muted uk-margin-remove-top uk-margin-right" style="margin-bottom:5px") Proyecto:
                            div(class="uk-width-expand uk-margin-small-left")
                                div(class="uk-width-1 uk-margin-remove-top uk-flex  uk-flex-wrap" style="margin-bottom:5px")
                                    div(class="uk-width-3-4@l uk-margin-small-top uk-flex uk-flex-between uk-flex-wrap-reverse" style="margin-bottom:5px")
                                        div(class="uk-text-small uk-text-default") Colegio Novel
                                        div(class="uk-text-small uk-text-muted") Estatus:
                                    div(class="uk-width-1-4@l uk-flex uk-flex-center uk-flex-wrap")
                                        span(class="uk-label uk-label-success uk-text-small") Activo
                                        div(style="flex-basis:100%")
                                        div(class="uk-text-small") Progreso 60%
                                progress( id="js-progressbar" class="uk-progress" value="60" max="100")
        div(id="user-form" uk-modal)
            div(class="uk-modal-dialog uk-modal-body")
                div(class="uk-text-left  uk-text-large uk-text-bold uk-text-primary") Agregar usuario
                button(type='button' uk-close='' class="uk-modal-close-default")
                div(id="errors")
                form(class="uk-card-body uk-padding-small" id="form-new-user" action="/usuarios/nuevo" method="POST" enctype="multipart/form-data")
                    div(class="uk-text-left uk-text-primary uk-margin-bottom") FOTO DE PERFIL
                        div(class="form-group uk-margin-top uk-border-circle")
                            img(src="/img/iconos/default.png" alt=""  id="avatar" class="uk-border-circle uk-margin-auto uk-flex" style="width:200px;height:200px; background-size:cover; object-fit:cover;")
                            a(id="foto" class="uk-flex uk-flex-center uk-flex-middle uk-width-1 uk-flex-wrap")
                                img(src="/img/iconos/edit.png" class="uk-flex" style="width:12px; height:12px;")
                                div() Agregar foto
                            input(name="fileField" type="file" id="fileField" style="visibility:hidden;width:2px")
                    div(class="uk-child-width-1-1 uk-grid")
                        div
                            div(class="uk-text-left uk-text-primary uk-margin-bottom") DATOS GENERALES
                            .field.uk-margin-bottom
                                input(type='text' autocomplete='on' id="name" name="name" value='' onchange="this.setAttribute('value', this.value);" required='')
                                label(for='name' title='Nombre Completo' data-title='Nombre Completo')
                            .field.uk-margin-bottom
                                input(type='email' autocomplete="nope"  id="email" name="email"  value='' onchange="this.setAttribute('value', this.value);" required='')
                                label(for='email' title='Correo electrónico' data-title='Correo electrónico')
                            .field.uk-margin-bottom
                                input(type='password' autocomplete='new-password'  id="password" name="password"  value='' onchange="this.setAttribute('value', this.value);" required='')
                                label(for='password' title='Contraseña (mínimo 8 caracteres)' data-title='Contraseña')
                            .field.uk-margin-bottom
                                input(type='password' autocomplete='new-password'  id="password-confirm" name="password-confirm"  value='' onchange="this.setAttribute('value', this.value);" required='')
                                label(for='password-confirm' title='Confirmar contraseña' data-title='Confirmar contraseña')
                            .field.uk-margin-bottom
                                select(id="role" name="role" autocomplete='off' value='' /*required*/)
                                    option(value="" disabled hidden selected ) Seleccionar
                                    option(value="arquitecto" ) Arquitecto
                                    option(value="adminisrador" ) Administrador
                                label(for='role' title='Rol' data-title='Rol')
                            .field.uk-margin-bottom
                                input(type='date' autocomplete='off'  id="hiring_date" name="hiring_date"  onchange="this.setAttribute('value', this.value);" required='')
                                label(for='hiring_date' title='Fecha de contratación' data-title='Fecha de contratación')
                        div
                            div(class="uk-text-left uk-text-primary uk-margin-bottom") DATOS DE CONTACTO
                            .field.uk-margin-bottom
                                input(type='text' autocomplete='tel' id="phone_number" name="phone_number" value='' onchange="this.setAttribute('value', this.value);" required='')
                                label(for='phone_number' title='Número telefónico' data-title='Número telefónico')
                            div(class="uk-grid")
                                div(class="uk-width-1-1@l uk-width-1-2@s uk-width-1-1")
                                    .field.uk-margin-bottom
                                        input(type='text' autocomplete='on' id="city" name="city" value='' onchange="this.setAttribute('value', this.value);" required='')
                                        label(for='city' title='Ciudad' data-title='Ciudad')
                                div(class="uk-width-1-1@l uk-width-1-2@s uk-width-1-1")
                                    .field.uk-margin-bottom
                                        input(type='text' autocomplete='on' id="state" name="state" value='' onchange="this.setAttribute('value', this.value);" required='')
                                        label(for='state' title='Estado' data-title='Estado')
                            .field.uk-margin-bottom
                                input(type='text' autocomplete='on'  id="suburb" name="suburb"  value='' onchange="this.setAttribute('value', this.value);" required='')
                                label(for='suburb' title='Colonia' data-title='Colonia')
                            .field.uk-margin-bottom
                                input(type='text' autocomplete='on'  id="street" name="street"  value='' onchange="this.setAttribute('value', this.value);" required='')
                                label(for='street' title='Calle' data-title='Calle')
                            div.uk-grid
                                div(class="uk-width-1-2@s uk-width-1-1")
                                    .field.uk-margin-bottom
                                        input(type='text' autocomplete='on'  id="ext_number" name="ext_number"  value='' onchange="this.setAttribute('value', this.value);" required='')
                                        label(for='ext_number' title='No. Exterior' data-title='No. Exterior')
                                div(class="uk-width-1-2@s uk-width-1-1")
                                    .field.uk-margin-bottom
                                        input(type='text' autocomplete='on'  id="int_number" name="int_number"  value='' onchange="this.setAttribute('value', this.value);")
                                        label(for='int_number' title='No. Interior (opcional)' data-title='No. Interior')
                            div(class="uk-width-1 uk-flex-right uk-flex")
                                button(class="uk-button uk-button-text uk-margin-medium-right uk-text-primary uk-text-capitalize" type="button" onclick="window.history.go(-1); return false;") Cancelar
                                button(class="uk-button uk-button-primary uk-border-rounded uk-text-capitalize" id="btnEnviar" type="submit") Agregar

    script.
         jQuery(($) => {
            $('#foto').on('click', function() {
                $("#fileField").click();
            });
            function readURL(input) {
                $('#avatar').attr('src', "/img/iconos/default.png");
                if (input.files && input.files[0]) {
                    var reader = new FileReader();

                    reader.onload = function(e) {
                    $('#avatar').attr('src', e.target.result);
                    }

                    reader.readAsDataURL(input.files[0]); // convert to base64 string
                }
            }

            $("#fileField").change(function() {
                readURL(this);
            });
        });


        $(document).ready(function () {
            $("#form-new-user").bind("submit",function(){
                // Capturamnos el boton de envío
                var btnEnviar = $("#btnEnviar");

                $.ajax({
                    type: $(this).attr("method"),
                    url: $(this).attr("action"),
                    data: new FormData(this),
                    dataType: "JSON",
                    processData: false,
                    contentType: false,
                    beforeSend: function(data){
                        /*
                        * Esta función se ejecuta durante el envió de la petición al
                        * servidor.
                        * */
                        // btnEnviar.text("Enviando"); Para button
                        btnEnviar.val("Enviando"); // Para input de tipo button
                        btnEnviar.attr("disabled","disabled");
                    },
                    complete:function(data){
                        /*
                        * Se ejecuta al termino de la petición
                        * */
                        btnEnviar.val("Enviar formulario");
                    },
                    success: function(data){
                        /*
                        * Se ejecuta cuando termina la petición y esta ha sido
                        * correcta
                        * */
                        $('#errors').css('display', 'none');
                        alert('Usuario registrado');
                        window.location.href = window.location.origin + '/usuarios'
                    },
                    error: function(data){
                        /*
                        * Se ejecuta si la peticón ha sido erronea
                        * */
                        btnEnviar.removeAttr("disabled");
                        $('#errors').css('display', 'block');
                        console.log(data.responseText);
                        var errors = JSON.parse(data.responseText);
                        var errorsContainer = $('#errors');
                        errorsContainer.innerHTML = '';
                        var errorsList = '';
                        for (var i = 0; i < errors.length; i++) {
                            //if(errors[i].redirect)
                                //window.location.href = window.location.origin + '/logout'
                            errorsList += '<div class="uk-alert-danger" uk-alert><a class="uk-alert-close" uk-close></a><p>'+ errors[i].msg +'</p></div>';
                        }
                        errorsContainer.html(errorsList);

                        alert("Problemas al tratar de enviar el formulario");
                    }
                });
                // Nos permite cancelar el envio del formulario
                return false;
            });
        });